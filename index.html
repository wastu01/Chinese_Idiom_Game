<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>成語測驗遊戲</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <div>
        <h1 class="mb-4 text-center">成語測驗遊戲</h1>
        <h3 class="mb-4 text-center"><a href="https://docs.google.com/document/d/1CGkAbbTZCINa-pF4idxS0LFFWCHu8UbEOGN68IiWiZU/edit?usp=sharing">目前進度</a></h3>
        </div>

        <div id="game-area" class="card p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
                <div id="score-display" class="fs-3 fw-bold text-primary">分數：0</div>
                <button id="start-btn" class="btn btn-success">開始遊戲</button>
            </div>
            <div class="progress mb-3" style="height: 12px;">
                <div id="timer-progress" class="progress-bar" role="progressbar" style="width: 100%;"></div>
            </div>
            <div id="question" class="mb-3 fs-5">Choose the right answer :</div>
            <div id="timer" class="mb-2">
                <span class="badge bg-secondary">
                    倒數：<span id="time-remaining">12</span> 秒
                </span>
            </div>
            <div id="choices" class="mb-3">

            </div>
            <div id="result" class="mt-3"></div>
            <div id="final-message" class="mt-4 fs-4 text-center"></div>
            <button id="next-btn" class="btn btn-primary mt-3 d-none">下一題</button>
            <button id="restart-btn" class="btn btn-outline-primary mt-3 d-none">重新開始</button>
        </div>
    </div>

    <script>
        // 預計讀取外部 JSON 檔案
        const idioms = [
            { question: "形容非常高興", answer: "欣喜若狂", choices: ["欣喜若狂", "一絲不苟", "畫蛇添足", "濫竽充數"] },
            { question: "形容做事非常認真", answer: "一絲不苟", choices: ["一絲不苟", "對牛彈琴", "井底之蛙", "亡羊補牢"] },
            { question: "比喻做了多餘的事", answer: "畫蛇添足", choices: ["畫蛇添足", "掩耳盜鈴", "守株待兔", "自相矛盾"] }
        ];
        let current = 0;

        const TIME_PER_QUESTION = 6; // 每題秒數（之後可調）
        const SCORE_PER_QUESTION = 10;
        let remaining = TIME_PER_QUESTION;
        let timerId = null;
        let answered = false;
        let score = 0;

        // Controls the visible countdown and ties it to question flow without resetting between rounds
        function startTimer(reset = false) {
            stopTimer();
            if (reset) {
                remaining = TIME_PER_QUESTION;
            }
            updateTimerUI();
            if (remaining <= 0) return;
            timerId = setInterval(() => {
                remaining -= 1;
                updateTimerUI();
                if (remaining <= 0) {
                    onTimeout();
                }
            }, 1000);
        }

        // Halts the countdown loop
        function stopTimer() {
            if (timerId !== null) {
                clearInterval(timerId);
                timerId = null;
            }
        }

        // Syncs numeric timer text and progress bar each second
        function updateTimerUI() {
            const el = document.getElementById('time-remaining');
            if (el) el.textContent = remaining;
            updateTimerProgress();
        }

        function updateTimerProgress() {
            const progressEl = document.getElementById('timer-progress');
            if (!progressEl) return;
            const clamped = Math.max(remaining, 0);
            const percent = (clamped / TIME_PER_QUESTION) * 100;
            progressEl.style.width = `${percent}%`;
            progressEl.setAttribute('aria-valuemin', '0');
            progressEl.setAttribute('aria-valuemax', `${TIME_PER_QUESTION}`);
            progressEl.setAttribute('aria-valuenow', `${clamped}`);
        }

        function updateScoreUI() {
            const scoreEl = document.getElementById('score-display');
            if (scoreEl) scoreEl.textContent = `分數：${score}`;
        }

        function onTimeout() {
            if (answered) return; // 已作答則忽略
            answered = true;
            stopTimer();
            Array.from(document.getElementById('choices').children).forEach(btn => btn.disabled = true);
            endGame();
        }

        function loadQuestion(resetTimer = false) {
            answered = false;
            stopTimer();
            remaining = Math.max(remaining, 0);
            const q = idioms[current];
            document.getElementById('question').textContent = q.question;
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            q.choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary m-2';
                btn.textContent = choice;
                btn.onclick = () => checkAnswer(choice);
                choicesDiv.appendChild(btn);
            });
            document.getElementById('result').textContent = '';
            document.getElementById('final-message').textContent = '';
            document.getElementById('next-btn').classList.add('d-none');
            document.getElementById('restart-btn').classList.add('d-none');
            document.getElementById('start-btn').classList.add('d-none');
            const shouldResetTimer = resetTimer || remaining <= 0;
            startTimer(shouldResetTimer);
        }

        function prepareGame() {
            stopTimer();
            current = 0;
            remaining = TIME_PER_QUESTION;
            answered = false;
            const questionEl = document.getElementById('question');
            questionEl.textContent = '請按開始遊戲';
            document.getElementById('choices').innerHTML = '';
            document.getElementById('result').textContent = '';
            document.getElementById('final-message').textContent = '';
            document.getElementById('next-btn').classList.add('d-none');
            document.getElementById('restart-btn').classList.add('d-none');
            document.getElementById('start-btn').classList.remove('d-none');
            updateTimerUI();
        }

        function checkAnswer(selected) {
            if (answered) return;
            answered = true;
            stopTimer();
            const q = idioms[current];
            const resultDiv = document.getElementById('result');
            if (selected === q.answer) {
                resultDiv.innerHTML = '<span class="text-success">回答正確！</span>';
                score += SCORE_PER_QUESTION;
                updateScoreUI();
            } else {
                resultDiv.innerHTML = `<span class="text-danger">回答錯誤，正确答案是：${q.answer}</span>`;
            }
            Array.from(document.getElementById('choices').children).forEach(btn => btn.disabled = true);
            document.getElementById('next-btn').classList.remove('d-none');
        }

        function endGame() {
            stopTimer();
            document.getElementById('question').textContent = '遊戲結束';
            document.getElementById('choices').innerHTML = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('final-message').innerHTML = `<span class="text-success">總分：${score}</span>`;
            document.getElementById('next-btn').classList.add('d-none');
            document.getElementById('restart-btn').classList.remove('d-none');
            document.getElementById('start-btn').classList.add('d-none');
        }

        document.getElementById('next-btn').onclick = function() {
            stopTimer();
            current++;
            if (current < idioms.length) {
                loadQuestion();
            } else {
                endGame();
            }
        };

        function restartGame() {
            score = 0;
            updateScoreUI();
            prepareGame();
        }

        document.getElementById('restart-btn').onclick = restartGame;

        document.getElementById('start-btn').onclick = function() {
            loadQuestion(true);
        };

        prepareGame();
        updateScoreUI();
    </script>
</body>
</html>
